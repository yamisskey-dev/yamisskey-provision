# tasks/main.yml
- name: Create Minecraft directory
  file:
    path: '{{ minecraft_dir }}'
    state: directory
    mode: '0755'
    owner: '{{ ansible_user }}'
    group: '{{ ansible_user }}'

- name: Create Minecraft data directory
  file:
    path: '{{ minecraft_dir }}/data'
    state: directory
    mode: '0755'
    owner: '{{ ansible_user }}'
    group: '{{ ansible_user }}'

# secrets.ymlã®å­˜åœ¨ç¢ºèª
- name: Check if secrets file exists
  stat:
    path: '{{ minecraft_secrets_file }}'
  register: minecraft_secrets_file_stat

# ç®¡ç†è€…UUIDã®ç”Ÿæˆ
- name: Generate admin UUID if not exists
  shell: 'python3 -c "import uuid; print(uuid.uuid4())"'
  register: admin_uuid_output
  when: not minecraft_secrets_file_stat.stat.exists

# RCONãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®ç”Ÿæˆ
- name: Generate RCON password if not exists
  shell: 'cat /dev/urandom | tr -dc "a-zA-Z0-9" | fold -w 32 | head -n 1'
  register: rcon_password_output
  when: not minecraft_secrets_file_stat.stat.exists

# ç§˜å¯†æƒ…å ±ã®è¨­å®š
- name: Set secrets facts
  set_fact:
    admin_uuid: "{{ (lookup('file', minecraft_secrets_file) | from_yaml).admin_uuid if minecraft_secrets_file_stat.stat.exists else admin_uuid_output.stdout }}"
    rcon_password: "{{ (lookup('file', minecraft_secrets_file) | from_yaml).rcon_password if minecraft_secrets_file_stat.stat.exists else rcon_password_output.stdout }}"

# ç§˜å¯†æƒ…å ±ã®ä¿å­˜ï¼ˆåˆå›ã®ã¿ï¼‰
- name: Save secrets to file
  copy:
    dest: '{{ minecraft_secrets_file }}'
    content: |
      admin_uuid: "{{ admin_uuid }}"
      rcon_password: "{{ rcon_password }}"
    mode: '0600'
    owner: '{{ ansible_user }}'
    group: '{{ ansible_user }}'
  when: not minecraft_secrets_file_stat.stat.exists

# ops.jsonã®ä½œæˆ
- name: Create ops.json
  copy:
    dest: '{{ minecraft_dir }}/data/ops.json'
    content: |
      [
        {
          "uuid": "{{ admin_uuid }}",
          "name": "admin",
          "level": 4,
          "bypassesPlayerLimit": true
        }
      ]
    mode: '0644'
    owner: '{{ ansible_user }}'
    group: '{{ ansible_user }}'
  when: not minecraft_secrets_file_stat.stat.exists

# ç’°å¢ƒå¤‰æ•°ãƒ•ã‚¡ã‚¤ãƒ«ã®é…ç½®
- name: Copy .env file
  template:
    src: minecraft.env.j2
    dest: '{{ minecraft_dir }}/.env'
    mode: '0600'
    owner: '{{ ansible_user }}'
    group: '{{ ansible_user }}'
  notify: restart minecraft

# Docker Composeè¨­å®šã®å±•é–‹
- name: Copy docker-compose.yml
  template:
    src: docker-compose.yml.j2
    dest: '{{ minecraft_dir }}/docker-compose.yml'
    mode: '0644'
    owner: '{{ ansible_user }}'
    group: '{{ ansible_user }}'
  notify: restart minecraft

# ãƒ—ãƒ©ã‚°ã‚¤ãƒ³è¨­å®šãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ä½œæˆ
- name: Create Minecraft plugins config directories
  file:
    path: '{{ item }}'
    state: directory
    mode: '0755'
    owner: '{{ ansible_user }}'
    group: '{{ ansible_user }}'
  loop:
    - '{{ minecraft_dir }}/data/plugins'
    - '{{ minecraft_dir }}/data/plugins/Geyser-Spigot'
    - '{{ minecraft_dir }}/data/plugins/floodgate'

# Geyserè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®é…ç½®
- name: Copy Geyser config
  template:
    src: geyser-config.yml.j2
    dest: '{{ minecraft_dir }}/data/plugins/Geyser-Spigot/config.yml'
    mode: '0644'
    owner: '{{ ansible_user }}'
    group: '{{ ansible_user }}'
  notify: restart minecraft

# Floodgateè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®é…ç½®
- name: Copy Floodgate config
  template:
    src: floodgate-config.yml.j2
    dest: '{{ minecraft_dir }}/data/plugins/floodgate/config.yml'
    mode: '0644'
    owner: '{{ ansible_user }}'
    group: '{{ ansible_user }}'
  notify: restart minecraft

# server.propertiesã®é…ç½®
- name: Copy server.properties
  template:
    src: server.properties.j2
    dest: '{{ minecraft_dir }}/data/server.properties'
    mode: '0644'
    owner: '{{ ansible_user }}'
    group: '{{ ansible_user }}'
  notify: restart minecraft

# ã‚µãƒ¼ãƒãƒ¼ã®èµ·å‹•
- name: Start Minecraft server
  community.docker.docker_compose:
    project_src: '{{ minecraft_dir }}'
    state: present
    pull: yes

- name: Enable and start Docker service
  systemd:
    name: docker
    state: started
    enabled: yes

# PlayIt.gg APTãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã¨è¨­å®šï¼ˆARM64å¯¾å¿œï¼‰
- name: PlayIt.gg setup helper
  block:
    - name: Install required packages for PlayIt.gg
      apt:
        name:
          - curl
          - gnupg
        state: present
        update_cache: yes
      become: true

    - name: Add PlayIt.gg APT repository key
      shell: |
        curl -SsL https://playit-cloud.github.io/ppa/key.gpg | gpg --dearmor | sudo tee /etc/apt/trusted.gpg.d/playit.gpg >/dev/null
      args:
        creates: /etc/apt/trusted.gpg.d/playit.gpg
      become: true

    - name: Add PlayIt.gg APT repository
      apt_repository:
        repo: "deb [signed-by=/etc/apt/trusted.gpg.d/playit.gpg] https://playit-cloud.github.io/ppa/data ./"
        filename: playit-cloud
        state: present
        update_cache: yes
      become: true

    - name: Install PlayIt.gg package
      apt:
        name: playit
        state: present
      become: true

    - name: Display PlayIt.gg manual setup information
      debug:
        msg: |
          ===============================================
          ğŸ”— PlayIt.gg ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ— - æ‰‹å‹•è¨­å®š
          ===============================================
          
          âœ… PlayIt.ggãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å®Œäº†
          
          ğŸ“‹ æ‰‹å‹•ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—æ‰‹é †:
          1. sudo /usr/local/bin/playit
             (åˆå›å®Ÿè¡Œã§Claim Codeã¨URLãŒè¡¨ç¤ºã•ã‚Œã¾ã™)
          
          2. è¡¨ç¤ºã•ã‚ŒãŸURLã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã‚¢ã‚«ã‚¦ãƒ³ãƒˆè¨­å®š
          
          3. ã‚µãƒ¼ãƒ“ã‚¹é–‹å§‹:
             sudo systemctl start playit.service
             sudo systemctl enable playit.service
          
          âš ï¸ é‡è¦:
          - åˆå›ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã¯æ‰‹å‹•ã§è¡Œã£ã¦ãã ã•ã„
          - ã‚¢ã‚«ã‚¦ãƒ³ãƒˆè¨­å®šå¾Œã€ã‚µãƒ¼ãƒ“ã‚¹ã‚’æ‰‹å‹•ã§é–‹å§‹ã—ã¦ãã ã•ã„
          ===============================================
  when: playit_enabled | default(false)

- name: Create playit systemd service template
  template:
    src: playit.service.j2
    dest: /etc/systemd/system/playit.service
    mode: '0644'
  become: true
  when: playit_enabled | default(false)

- name: Reload systemd daemon for playit service
  systemd:
    daemon_reload: yes
  become: true
  when: playit_enabled | default(false)