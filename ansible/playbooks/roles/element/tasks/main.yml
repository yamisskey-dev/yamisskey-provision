- name: Create element directory
  file:
    path: /var/www/element
    state: directory

- name: Create element-config directory
  file:
    path: /var/www/element/element-config
    state: directory

- name: Create element directory
  file:
    path: /var/www/element
    state: directory

- name: Copy docker-compose.yml for element
  template:
    src: element_docker-compose.yml.j2
    dest: /var/www/element/docker-compose.yml

- name: Copy element config.json
  template:
    src: element.config.json.j2
    dest: /var/www/element/element-config/config.json

- name: Start element
  docker_compose:
    project_src: /var/www/element
    state: present
    restarted: yes

- name: Obtain SSL certificate for element with certbot and Cloudflare
  command: certbot certonly --dns-cloudflare --dns-cloudflare-credentials /etc/cloudflare/cloudflare.ini -d element.yami.ski --non-interactive --agree-tos -m yamisskey@proton.me
  when: matrix_use_ssl

- name: Copy nginx configuration for element
  template:
    src: nginx_element.conf.j2
    dest: /etc/nginx/conf.d/element.conf

- name: Restart nginx
  service:
    name: nginx
    state: restarted

- name: Stop cloudflared service if running
  systemd:
    name: cloudflared
    state: stopped
    enabled: false
  ignore_errors: yes

- name: Find cloudflared UUID file
  find:
    paths: '/home/{{ ansible_user }}/.cloudflared'
    patterns: '*.json'
  register: uuid_files

- name: Set tunnel UUID
  set_fact:
    tunnel_uuid: "{{ item.path | regex_replace('^.*/(.*)\\.json$', '\\1') }}"
  loop: '{{ uuid_files.files }}'
  when: uuid_files.matched > 0
  changed_when: false

- name: Fail if no UUID file is found
  fail:
    msg: 'No cloudflared UUID file found in /home/{{ ansible_user }}/.cloudflared'
  when: uuid_files.matched == 0

- name: Debug tunnel_uuid
  debug:
    msg: 'Tunnel UUID: {{ tunnel_uuid }}'

- name: Set cloudflared config.yml content
  template:
    src: templates/cloudflared.config.yml.j2
    dest: /etc/cloudflared/config.yml
    owner: 'root'
    mode: '0600'
  notify: Restart Cloudflared

- name: Install cloudflared as a system service
  command: cloudflared service install
  args:
    creates: /etc/systemd/system/cloudflared.service

- name: Reload systemd to apply new service file
  command: systemctl daemon-reload

- name: Start and enable cloudflared service
  systemd:
    name: cloudflared
    state: started
    enabled: true
  become: true