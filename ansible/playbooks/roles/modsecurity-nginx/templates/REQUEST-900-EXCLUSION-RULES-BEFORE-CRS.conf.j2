# Custom ModSecurity rules executed before CRS
# These rules allow for customization and exclusions specific to your application

{% if modsecurity_custom_rules_before %}
# Custom rules before CRS
{% for rule in modsecurity_custom_rules_before %}
{{ rule }}
{% endfor %}
{% endif %}

# Default exclusions for common false positives
# Exclude Misskey-specific endpoints from certain rules
SecRule REQUEST_URI "@beginsWith /api/" \
    "id:900001,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ctl:ruleRemoveById=920320"

# Exclude WebSocket upgrade requests
SecRule REQUEST_HEADERS:Upgrade "@rx websocket" \
    "id:900002,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ctl:ruleRemoveById=920430"

# Exclude JSON content type checks for API endpoints
SecRule REQUEST_URI "@rx ^/api/" \
    "id:900003,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ctl:ruleRemoveById=920460"

# Allow larger file uploads for media
SecRule REQUEST_URI "@rx ^/api/drive/files/create$" \
    "id:900004,\
    phase:1,\
    pass,\
    t:none,\
    nolog"

# PostHog analytics cookie exclusion - prevent false positive SQL injection detection
SecRule REQUEST_COOKIES_NAMES "@rx ph_phc_.*_posthog" \
    "id:900005,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ctl:ruleRemoveTargetById=942200;REQUEST_COOKIES,\
    ctl:ruleRemoveTargetById=942340;REQUEST_COOKIES,\
    ctl:ruleRemoveTargetById=942370;REQUEST_COOKIES"
