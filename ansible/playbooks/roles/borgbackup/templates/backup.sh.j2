#!/bin/bash
set -e

# 基本設定
CONFIG_FILE="{{ borg_backup_dir }}/config/config.sh"
LOCK_FILE="/tmp/borg-backup.lock"
LOG_FILE="{{ borg_backup_log_file }}"

# ロック処理
if [ -e "$LOCK_FILE" ]; then
  PID=$(cat "$LOCK_FILE")
  if ps -p "$PID" > /dev/null; then
    echo "別のバックアッププロセスが実行中です (PID: $PID)"
    exit 1
  else
    rm -f "$LOCK_FILE"
  fi
fi
echo $$ > "$LOCK_FILE"
trap 'rm -f "$LOCK_FILE"' EXIT

# 設定ファイル読み込み
[ -f "$CONFIG_FILE" ] && source "$CONFIG_FILE" || { echo "設定ファイルがありません: $CONFIG_FILE"; exit 1; }

# ログ関数
log() { echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a "$LOG_FILE"; }

# エラーハンドラ
error_handler() {
  log "エラー: $1"
  # Discord通知（設定ファイルがある場合）
  if [ -f "/opt/misskey-backup/config/env.yml" ]; then
    source /opt/misskey-backup/config/env.yml
    [ -n "${DISCORD_WEBHOOK_URL:-}" ] && \
      curl -s -H "Content-Type: application/json" \
      -d "{\"content\":\"⚠️ **Borgバックアップエラー** ($(hostname)): $1\"}" \
      "$DISCORD_WEBHOOK_URL"
  fi
  exit 1
}

# ラズパイのTailscale IPアドレスを動的に取得
log "ラズベリーパイへの接続を試行中..."
RPI_HOST="{{ raspberry_pi_host }}"

# Tailscaleからラズパイのアドレスを取得
RPI_IP="$(tailscale status | grep -w "$RPI_HOST" | awk '{print $1}')"
if [ -z "$RPI_IP" ]; then
  # IPが取得できない場合はホスト名をそのまま使用
  log "Tailscaleからのラズパイ情報取得に失敗しました。ホスト名で試行します..."
  RPI_IP="$RPI_HOST"
else
  log "Tailscaleから $RPI_HOST のIPを取得しました: $RPI_IP"
  
  # リポジトリURLの置換（ホスト名→IPアドレス）
  OLD_REPOSITORIES=("${REPOSITORIES[@]}")
  REPOSITORIES=()
  for repo_data in "${OLD_REPOSITORIES[@]}"; do
    IFS=':' read -r repo_name repo_url paths_raw excludes_raw <<< "$repo_data"
    # ホスト名をIPアドレスに置き換え
    repo_url="${repo_url/$RPI_HOST/$RPI_IP}"
    REPOSITORIES+=("$repo_name:$repo_url:$paths_raw:$excludes_raw")
  done
fi

# 接続テスト (最終確認)
if ! ping -c 1 "$RPI_IP" &>/dev/null; then
  error_handler "ラズベリーパイに接続できません: $RPI_IP"
fi

# バックアップ開始
log "===== バックアップ開始: $(date) ====="

# 以下は既存のバックアップ処理コード
# レポジトリごとのバックアップ処理
for repo_data in "${REPOSITORIES[@]}"; do
  # 設定を分解
  IFS=':' read -r repo_name repo_url paths_raw excludes_raw <<< "$repo_data"
  IFS=',' read -ra backup_paths <<< "$paths_raw"
  
  # 以下は変更なし