#!/bin/bash
set -e

# 基本設定
CONFIG_FILE="{{ borg_backup_dir }}/config/config.sh"
LOCK_FILE="/tmp/borg-backup.lock"
LOG_FILE="{{ borg_backup_log_file }}"
HELPERS_FILE="{{ borg_backup_dir }}/helpers.sh"
BACKUP_SUCCESS=0

# ヘルパー関数の読み込み
[ -f "$HELPERS_FILE" ] && source "$HELPERS_FILE" || { echo "ヘルパーファイルがありません: $HELPERS_FILE"; exit 1; }

# ロック処理
create_lock
trap 'rm -f "$LOCK_FILE"; backup_completion' EXIT

# 設定ファイル読み込み
[ -f "$CONFIG_FILE" ] && source "$CONFIG_FILE" || { echo "設定ファイルがありません: $CONFIG_FILE"; exit 1; }

# ラズパイのIP取得とリポジトリURL更新
log "ラズベリーパイへの接続を試行中..."
RPI_HOST="{{ raspberry_pi_host }}"
RPI_IP=$(get_raspberry_pi_ip "$RPI_HOST")

# リポジトリURLの置換（ホスト名→IPアドレス）
if [ "$RPI_IP" != "$RPI_HOST" ]; then
  OLD_REPOSITORIES=("${REPOSITORIES[@]}")
  REPOSITORIES=()
  for repo_data in "${OLD_REPOSITORIES[@]}"; do
    IFS=':' read -r repo_name repo_url paths_raw excludes_raw <<< "$repo_data"
    repo_url="${repo_url/$RPI_HOST/$RPI_IP}"
    REPOSITORIES+=("$repo_name:$repo_url:$paths_raw:$excludes_raw")
  done
fi

# 接続テスト
log "ラズベリーパイの接続を確認中... ($RPI_IP)"
if ! ping -c 1 "$RPI_IP" &>/dev/null; then
  error_handler "ラズベリーパイ($RPI_IP)に接続できません"
fi

# SSH接続テスト
log "SSH接続を確認中..."
if ! ssh -o BatchMode=yes -o ConnectTimeout=5 "{{ raspberry_pi_user }}@$RPI_IP" "echo SSH接続成功" &>/dev/null; then
  error_handler "SSH接続に失敗しました。キーが正しく設定されているか確認してください。"
fi

# バックアップディレクトリ確認
log "バックアップディレクトリを確認中..."
if ! ssh -o BatchMode=yes "{{ raspberry_pi_user }}@$RPI_IP" "test -d {{ raspberry_pi_backup_dir }}/{{ actual_hostname }}" &>/dev/null; then
  log "バックアップディレクトリが存在しません。作成します..."
  ssh -o BatchMode=yes "{{ raspberry_pi_user }}@$RPI_IP" "mkdir -p {{ raspberry_pi_backup_dir }}/{{ actual_hostname }}" || error_handler "バックアップディレクトリの作成に失敗しました"
fi

# バックアップ開始
log "===== バックアップ開始: $(date) ====="

# レポジトリごとのバックアップ処理
for repo_data in "${REPOSITORIES[@]}"; do
  # 設定を分解
  IFS=':' read -r repo_name repo_url paths_raw excludes_raw <<< "$repo_data"
  IFS=',' read -ra backup_paths <<< "$paths_raw"
  
  # パスフレーズ設定
  eval export BORG_PASSPHRASE=\$BORG_PASSPHRASE_${repo_name^^}

  log "リポジトリ $repo_name へのバックアップを開始します"

  # バックアップ作成
  backup_cmd="borg create --stats --compression zstd,3"

  # コマンド構築（リポジトリURLとアーカイブ名を正しく構成）
  backup_cmd+=" \"$repo_url::$repo_name-{now:%Y-%m-%d_%H:%M}\""

  # バックアップ対象パスを追加
  for path in "${backup_paths[@]}"; do
    backup_cmd+=" \"$path\""
  done
  
  log "コマンド実行: $backup_cmd"
  eval "$backup_cmd" || error_handler "バックアップの作成に失敗しました: $repo_name"
  
  # 古いバックアップのプルーニング
  log "古いバックアップをプルーニング中..."
  borg prune --stats \
    --keep-daily ${KEEP_DAILY:-7} \
    --keep-weekly ${KEEP_WEEKLY:-4} \
    --keep-monthly ${KEEP_MONTHLY:-6} \
    "$repo_url" || log "プルーニングに失敗しました"
    
  # 月に1回だけリポジトリの整合性チェック
  if [ "$(date +%d)" = "01" ] || [ "$FORCE_CHECK" = "true" ]; then
    log "リポジトリチェックを実行中..."
    borg check "$repo_url" || log "リポジトリチェックに失敗しました"
  fi
  
  log "リポジトリ $repo_name のバックアップが完了しました"
done

# 全て正常に完了したフラグを設定
BACKUP_SUCCESS=1

log "すべてのバックアップ処理が完了しました"